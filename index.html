<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Furniture Floor Plan Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .focusable-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        #interactive {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            margin: 20px 0;
            background-color: #333;
            border-radius: 12px;
        }
        #interactive video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30%;
            height: 10%;
            border: 2px solid red;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 0, 1); }
            100% { box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col">
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-slate-900">Floor Plan Tracker</h1>
            <p class="text-slate-500 mt-2">Log furniture items and their tile locations.</p>
        </header>

        <div id="live-scanner-container" class="hidden fixed inset-0 bg-white bg-opacity-95 flex flex-col items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-md w-full max-w-lg mx-auto">
                <h2 class="text-2xl font-bold text-center mb-4">Scan Product Name</h2>
                <div id="interactive">
                    <video id="video-stream" autoplay playsinline></video>
                    <div id="scanner-overlay"></div>
                </div>
                <div class="flex gap-4 mt-4">
                    <button id="scanFrameBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all shadow-sm hover:shadow-md">
                        Scan Frame
                    </button>
                    <button id="cancelScanBtn" class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all shadow-sm hover:shadow-md">
                        Cancel
                    </button>
                </div>
            </div>
            <div id="ocr-loader-live" class="absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-50 backdrop-blur-sm hidden">
                <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loader-text-live" class="mt-4 text-slate-600 font-medium">Processing frame...</p>
            </div>
        </div>

        <main class="bg-white p-6 rounded-2xl shadow-md flex-grow">
            <div class="space-y-4">
                <button id="scanTextBtn" class="w-full border-2 border-dashed border-slate-300 text-slate-500 font-semibold py-3 px-4 rounded-lg hover:bg-slate-100 hover:border-slate-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                    Scan Product Name
                </button>
                <div class="relative flex items-center justify-center"><hr class="w-full border-slate-200"><span class="absolute px-2 bg-white text-slate-400 text-sm">OR</span></div>
                <div>
                    <label for="productName" class="block text-sm font-medium text-slate-600 mb-1">Enter Product Name Manually</label>
                    <input type="text" id="productName" placeholder="e.g., 'Cobar Coffee Table'" class="w-full px-4 py-2 border border-slate-300 rounded-lg focusable-input transition-shadow">
                </div>
                <div>
                    <label for="tileLocation" class="block text-sm font-medium text-slate-600 mb-1">Tile Location</label>
                    <input type="text" id="tileLocation" placeholder="e.g., 'FF03, FF04'" class="w-full px-4 py-2 border border-slate-300 rounded-lg focusable-input transition-shadow">
                </div>
                <button id="addItemBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all shadow-sm hover:shadow-md">Add Item</button>
            </div>
            <hr class="my-6 border-slate-200">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Logged Items</h2>
                     <button id="exportBtn" class="bg-green-600 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all shadow-sm hover:shadow-md disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Export to CSV</button>
                </div>
                <div id="itemList" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                    <p id="emptyMessage" class="text-center text-slate-500 py-4">No items added yet.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center py-4 text-slate-400 text-sm mt-4">
            <p>&copy; Michael's Floorplan Scanner</p>
        </footer>
    </div>

    <script>
        /**
         * Main application object to encapsulate all logic for the Floor Plan Tracker.
         */
        const FloorPlanTracker = {
            state: {
                items: [],
                worker: null,
                stream: null,
                cvReady: false,
            },

            dom: {
                // Main UI
                productNameInput: null,
                tileLocationInput: null,
                addItemBtn: null,
                itemListDiv: null,
                exportBtn: null,
                emptyMessage: null,
                // Scanner UI
                scanTextBtn: null,
                liveScannerContainer: null,
                videoStream: null,
                cancelScanBtn: null,
                scanFrameBtn: null,
                ocrLoaderLive: null,
                loaderTextLive: null,
            },

            /**
             * Initializes the application.
             */
            init() {
                this.selectDOM();
                this.bindEvents();
                this.loadOpenCV();
                this.itemManager.load();
                this.itemManager.render();
            },

            /**
             * Selects all necessary DOM elements and stores them for easy access.
             */
            selectDOM() {
                const D = this.dom; // Shorthand
                D.productNameInput = document.getElementById('productName');
                D.tileLocationInput = document.getElementById('tileLocation');
                D.addItemBtn = document.getElementById('addItemBtn');
                D.itemListDiv = document.getElementById('itemList');
                D.exportBtn = document.getElementById('exportBtn');
                D.emptyMessage = document.getElementById('emptyMessage');
                D.scanTextBtn = document.getElementById('scanTextBtn');
                D.liveScannerContainer = document.getElementById('live-scanner-container');
                D.videoStream = document.getElementById('video-stream');
                D.cancelScanBtn = document.getElementById('cancelScanBtn');
                D.scanFrameBtn = document.getElementById('scanFrameBtn');
                D.ocrLoaderLive = document.getElementById('ocr-loader-live');
                D.loaderTextLive = document.getElementById('loader-text-live');
            },
            
            /**
             * Binds all event listeners for the application.
             */
            bindEvents() {
                this.dom.addItemBtn.addEventListener('click', () => this.itemManager.add());
                this.dom.exportBtn.addEventListener('click', () => this.itemManager.exportToCSV());
                this.dom.scanTextBtn.addEventListener('click', () => this.scanner.start());
                this.dom.scanFrameBtn.addEventListener('click', () => this.scanner.scanFrame());
                this.dom.cancelScanBtn.addEventListener('click', () => this.scanner.stop());
            },

            /**
             * Loads the OpenCV.js script programmatically.
             */
            loadOpenCV() {
                const script = document.createElement('script');
                script.src = 'https://docs.opencv.org/4.9.0/opencv.js';
                script.async = true;
                script.onload = () => {
                    this.state.cvReady = true;
                    console.log("OpenCV.js is ready.");
                };
                script.onerror = () => {
                    console.error("Failed to load OpenCV.js");
                    alert("Critical error: Image processing library failed to load. Please refresh the page.");
                };
                document.head.appendChild(script);
            },

            // --- UI Management Module ---
            ui: {
                showLoader(message) {
                    FloorPlanTracker.dom.loaderTextLive.textContent = message;
                    FloorPlanTracker.dom.ocrLoaderLive.classList.remove('hidden');
                },
                hideLoader() {
                    FloorPlanTracker.dom.ocrLoaderLive.classList.add('hidden');
                },
                showScanner() {
                    FloorPlanTracker.dom.liveScannerContainer.classList.remove('hidden');
                },
                hideScanner() {
                    FloorPlanTracker.dom.liveScannerContainer.classList.add('hidden');
                },
            },

            // --- Item Management Module ---
            itemManager: {
                load() {
                    FloorPlanTracker.state.items = JSON.parse(localStorage.getItem('floorPlanItems')) || [];
                },
                save() {
                    localStorage.setItem('floorPlanItems', JSON.stringify(FloorPlanTracker.state.items));
                },
                render() {
                    const { items } = FloorPlanTracker.state;
                    const { itemListDiv, emptyMessage, exportBtn } = FloorPlanTracker.dom;
                    
                    itemListDiv.innerHTML = '';
                    
                    if (items.length === 0) {
                        emptyMessage.classList.remove('hidden');
                        exportBtn.disabled = true;
                    } else {
                        emptyMessage.classList.add('hidden');
                        exportBtn.disabled = false;
                        items.forEach((item, index) => {
                            const itemElement = document.createElement('div');
                            itemElement.className = 'bg-slate-100 p-4 rounded-lg flex justify-between items-center';
                            itemElement.innerHTML = `
                                <div>
                                    <p class="font-medium text-slate-800">${item.product}</p>
                                    <p class="text-sm text-slate-500">${item.location}</p>
                                </div>
                                <button onclick="FloorPlanTracker.itemManager.remove(${index})" class="text-red-500 hover:text-red-700 font-semibold text-xl">&times;</button>
                            `;
                            itemListDiv.appendChild(itemElement);
                        });
                    }
                },
                add() {
                    const { productNameInput, tileLocationInput, addItemBtn } = FloorPlanTracker.dom;
                    const product = productNameInput.value.trim();
                    const location = tileLocationInput.value.trim();

                    if (product && location) {
                        FloorPlanTracker.state.items.push({ product, location });
                        this.save();
                        this.render();
                        productNameInput.value = '';
                        tileLocationInput.value = '';
                        productNameInput.focus();
                    } else {
                        addItemBtn.textContent = 'Please fill out both fields!';
                        addItemBtn.classList.add('bg-red-500');
                        setTimeout(() => {
                            addItemBtn.textContent = 'Add Item';
                            addItemBtn.classList.remove('bg-red-500');
                        }, 1500);
                    }
                },
                remove(index) {
                    FloorPlanTracker.state.items.splice(index, 1);
                    this.save();
                    this.render();
                },
                exportToCSV() {
                    const header = ['Product Name', 'Tile Location'];
                    const csv = FloorPlanTracker.state.items.map(item => `"${item.product}","${item.location}"`);
                    const csvContent = "data:text/csv;charset=utf-8," + header.join(',') + '\n' + csv.join('\n');
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', 'floor_plan_data.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },

            // --- Scanner Module ---
            scanner: {
                async start() {
                    const FPT = FloorPlanTracker; // Shorthand
                    FPT.ui.showScanner();
                    FPT.ui.showLoader('Initializing...');

                    try {
                        if (!FPT.state.cvReady) {
                            FPT.ui.showLoader('Loading image libraries...');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            if (!FPT.state.cvReady) throw new Error("OpenCV.js failed to load.");
                        }
                        
                        FPT.ui.showLoader('Initializing camera...');
                        FPT.state.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        FPT.dom.videoStream.srcObject = FPT.state.stream;
                        
                        FPT.dom.videoStream.onloadedmetadata = () => {
                            FPT.dom.videoStream.play();
                            FPT.ui.hideLoader();
                        };

                        if (!FPT.state.worker) {
                           FPT.state.worker = await Tesseract.createWorker('eng');
                        }
                    } catch (err) {
                        console.error("Scanner failed to start:", err);
                        alert("Could not start scanner. Please ensure camera permissions are granted and refresh the page.");
                        this.stop();
                    }
                },
                stop() {
                    const FPT = FloorPlanTracker;
                    if (FPT.state.stream) {
                        FPT.state.stream.getTracks().forEach(track => track.stop());
                        FPT.state.stream = null;
                    }
                    if (FPT.state.worker) {
                        FPT.state.worker.terminate();
                        FPT.state.worker = null;
                    }
                    FPT.ui.hideScanner();
                },
                async scanFrame() {
                    const FPT = FloorPlanTracker;
                    if (!FPT.state.cvReady) {
                        alert("Image processing library not ready. Please wait.");
                        return;
                    }
                    
                    FPT.ui.showLoader('Processing frame...');

                    const canvas = document.createElement('canvas');
                    let src = null;
                    let dst = null;

                    try {
                        const video = FPT.dom.videoStream;
                        if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

                        const roiWidth = video.videoWidth * 0.30;
                        const roiHeight = video.videoHeight * 0.10;
                        const roiX = (video.videoWidth - roiWidth) / 2;
                        const roiY = (video.videoHeight - roiHeight) / 2;

                        canvas.width = roiWidth;
                        canvas.height = roiHeight;
                        canvas.getContext('2d').drawImage(video, roiX, roiY, roiWidth, roiHeight, 0, 0, roiWidth, roiHeight);

                        // Use OpenCV for superior image processing
                        src = cv.imread(canvas);
                        dst = new cv.Mat();
                        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY, 0);
                        cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);
                        cv.imshow(canvas, dst);
                        
                        const { data: { text } } = await FPT.state.worker.recognize(canvas, {}, {
                            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 -',
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE 
                        });

                        const firstLine = text.split('\n')[0].trim();
                        const match = firstLine.match(/[A-Za-z0-9][A-Za-z0-9 -]{2,39}/);

                        if (match && match[0]) {
                            FPT.ui.hideLoader(); // Hide loader before confirm dialog
                            const cleanText = match[0];
                            const isConfirmed = confirm(`Scanned: "${cleanText}"\n\nIs this correct?`);

                            if (isConfirmed) {
                                FPT.dom.productNameInput.value = cleanText;
                                this.stop();
                                FPT.dom.tileLocationInput.focus();
                            } else {
                                FPT.ui.showLoader('Scan rejected. Try again.');
                                setTimeout(() => FPT.ui.hideLoader(), 1500);
                            }
                        } else {
                            FPT.ui.showLoader('Text not found. Try again.');
                            setTimeout(() => FPT.ui.hideLoader(), 1500);
                        }
                    } catch (error) {
                        console.error("OCR Error:", error);
                        FPT.ui.showLoader('Scan failed. Please try again.');
                        setTimeout(() => FPT.ui.hideLoader(), 1500);
                    } finally {
                        if (src) src.delete();
                        if (dst) dst.delete();
                    }
                }
            }
        };

        // Start the application once the DOM is fully loaded.
        window.addEventListener('DOMContentLoaded', () => FloorPlanTracker.init());
        
    </script>
    <script>
        // Service Worker registration (kept separate for clarity)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
